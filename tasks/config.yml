---

- name: Read current mysql-interfaces from ProxySQL admin
  community.mysql.mysql_query:
    login_host: "{{ proxysql_admin_host }}"
    login_port: "{{ proxysql_admin_port }}"
    login_user: "{{ proxysql_admin_user }}"
    login_password: "{{ proxysql_admin_password }}"
    query: "SELECT variable_value FROM global_variables WHERE variable_name='mysql-interfaces';"
  register: proxysql3_current_interfaces
  changed_when: false

- name: Set mysql-interfaces (save to disk; restart required)
  community.proxysql.proxysql_global_variables:
    login_host: "{{ proxysql_admin_host }}"
    login_port: "{{ proxysql_admin_port }}"
    login_user: "{{ proxysql_admin_user }}"
    login_password: "{{ proxysql_admin_password }}"
    variable: "mysql-interfaces"
    value: "{{ proxysql_mysql_interfaces }}"
    save_to_disk: true
    load_to_runtime: false
  when: (proxysql3_current_interfaces.query_result[0].variable_value | default('')) != proxysql_mysql_interfaces
  notify: Restart proxysql

- name: Configure mysql monitor credentials (runtime + disk)
  community.proxysql.proxysql_global_variables:
    login_host: "{{ proxysql_admin_host }}"
    login_port: "{{ proxysql_admin_port }}"
    login_user: "{{ proxysql_admin_user }}"
    login_password: "{{ proxysql_admin_password }}"
    variable: "{{ item.variable }}"
    value: "{{ item.value }}"
    save_to_disk: true
    load_to_runtime: true
  loop:
    - { variable: "mysql-monitor_username", value: "{{ proxysql_monitor_username }}" }
    - { variable: "mysql-monitor_password", value: "{{ proxysql_monitor_password }}" }
  when: proxysql_monitor_password | length > 0
  no_log: true

- name: Flush handlers (apply interface change if needed)
  ansible.builtin.meta: flush_handlers
